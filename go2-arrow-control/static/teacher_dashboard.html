<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teacher Dashboard</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <div class="container">
        <header>
            <h1>Teacher Dashboard</h1>
            <a href="{{ url_for('teacher_logout') }}" class="btn btn-danger" style="float:right">Logout</a>
        </header>

        <div class="main-content">
            <div class="settings-column">
                <h3>Settings</h3>
                <form id="teacher-settings-form" method="post" action="{{ url_for('teacher_update_settings') }}">
                    <div class="form-group">
                        <label for="confidence_threshold">Confidence Threshold (0-1):</label>
                        <input type="number" step="0.01" min="0" max="1" id="confidence_threshold" name="confidence_threshold" value="{{ settings.confidence_threshold }}">
                        <small class="help-text">Minimum prediction certainty required. Higher values (e.g., 0.85) prevent false movements but might ignore less clear gestures.</small>
                    </div>
                    <div class="form-group">
                        <label for="max_speed">Max Speed (m/s):</label>
                        <input type="number" step="0.01" min="0" max="1" id="max_speed" name="max_speed" value="{{ settings.max_speed }}">
                        <small class="help-text">Maximum linear and angular velocity. Controls how fast the robot moves forward or rotates. <strong>Safety tip:</strong> start at 0.2.</small>
                    </div>
                    <div class="form-group">
                        <label for="command_interval">Command Interval (seconds):</label>
                        <input type="number" step="0.1" min="0" id="command_interval" name="command_interval" value="{{ settings.command_interval }}">
                        <small class="help-text">Time between sending commands. Lower values (e.g., 0.2) provide "snappier" response; higher values (e.g., 1.0) provide smoother, more deliberate movement.</small>
                    </div>
                    <div class="form-group">
                        <label for="buffer_size">Buffer Size (frames):</label>
                        <input type="number" min="1" id="buffer_size" name="buffer_size" value="{{ settings.buffer_size }}">
                        <small class="help-text">Memory of recent frames. Larger buffers provide more stability at the cost of slight latency.</small>
                    </div>
                    <div class="form-group">
                        <label for="consensus_required">Consensus Required (frames):</label>
                        <input type="number" min="1" id="consensus_required" name="consensus_required" value="{{ settings.consensus_required }}">
                        <small class="help-text">Number of frames in the buffer that must agree on the same label before the robot executes it. High consensus = high reliability.</small>
                    </div>

                    <button type="submit" class="btn btn-primary">Save Settings</button>
                </form>

                <div id="result" style="margin-top:10px"></div>
            </div>

            <div class="doc-column">
                <div class="doc-section">
                    <h4>System Documentation</h4>
                    <div class="alert-danger">
                        <h5>ðŸš¨ Emergency Safety</h5>
                        <p>The system has a built-in <strong>Emergency Stop</strong> feature. Clicking the red button on the student hub immediately kills all motions and disables automated control.</p>
                        <p><strong>Failsafe:</strong> If the robot loses connection to the AI server for more than 2 seconds, it will automatically stop (Command Timeout).</p>
                    </div>

                    <h5>How Steering Works</h5>
                    <ul>
                        <li><strong>Forward:</strong> Increases <code>vx</code> (linear velocity). Linear speed is capped by <em>Max Speed</em>.</li>
                        <li><strong>Left/Right:</strong> Interpreted as <strong>Yaw Velocity</strong> (rotation). The robot pivots in place using the <em>Max Speed</em> value as its rotation rate (radians/second).</li>
                        <li><strong>Confidence Check:</strong> If a frame's confidence is below threshold, it is ignored by the steering logic.</li>
                        <li><strong>Consensus:</strong> Prevents "jittery" steering. If the AI rapidly alternates between 'Left' and 'Forward', the buffer filters it out until one command dominates.</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <script>
    document.getElementById('teacher-settings-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const form = e.target;
        const formData = new FormData(form);
        const data = {};
        for (const [k,v] of formData.entries()) data[k]=v;

        const resp = await fetch(form.action, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });
        const json = await resp.json();
        const result = document.getElementById('result');
        if (json.success) {
            result.textContent = 'Settings saved âœ“';
            result.style.color = 'green';
        } else {
            result.textContent = 'Error: ' + (json.error || 'unknown');
            result.style.color = 'red';
        }
    });
    </script>
</body>
</html>
